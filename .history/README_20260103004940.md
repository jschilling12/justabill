# Just A Bill - Bill Vote Breakdown

A web application that lets users explore and vote on sections of active U.S. federal bills, providing a personalized "support score" and recap based on their votes.

## Architecture Overview

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│   n8n       │────>│   Backend    │────>│  Postgres   │
│ Workflows   │     │  (FastAPI)   │     │   Database  │
└─────────────┘     └──────────────┘     └─────────────┘
                           │                      
                           ├─────> Redis (Cache/Queue)
                           │
                    ┌──────┴──────┐
                    │             │
              ┌─────▼────┐  ┌────▼─────┐
              │  Worker  │  │ Frontend │
              │(Summarize)│  │(Next.js) │
              └──────────┘  └──────────┘
```

## Components

### 1. Backend (FastAPI)
- REST API for bill data, voting, and user summaries
- Bill ingestion and sectioning logic
- Vote aggregation and support score calculation
- LLM abstraction layer (OpenAI/Anthropic/local)

### 2. Worker (Background Processing)
- Async summarization of bill sections
- Evidence extraction from bill text
- Grounded summary generation (no hallucinations)

### 3. Frontend (Next.js)
- Browse active federal bills
- Vote on individual sections (Upvote/Downvote/Skip)
- View personalized support score and recap
- Display grounded summaries with evidence quotes

### 4. n8n Workflows
- **Daily Bill Sync**: Fetches bills updated in last 24h from Congress.gov API
- **Re-summarization**: On-demand workflow to refresh summaries
- **Alert/Dead Letter**: Error handling and notifications

### 5. Data Sources
- **Congress.gov API** (api.data.gov): Bill metadata and text version URLs
- **GovInfo API**: Full bill text when needed
- All summaries link back to official source text

## Data Flow

1. **Ingestion**: n8n → Backend `/ingest/bill` → Fetch text → Split sections → Queue for summarization
2. **Summarization**: Worker → LLM (grounded prompt) → Store summary + evidence quotes
3. **Voting**: User → Frontend → Backend `/bills/{id}/vote` → Store vote → Update aggregates
4. **Recap**: Frontend → Backend `/bills/{id}/user-summary` → Calculate support score → Return liked/disliked sections

## Anti-Hallucination Guarantees

- **Grounded summaries**: Every summary is based solely on the fetched bill text
- **Evidence quotes**: 1-3 short quotes (<25 words) stored per section as proof
- **No invention**: No sponsors, costs, dates, or effects not in the source text
- **Neutral framing**: No "you should vote X" - only "what it does" language
- **Source links**: Every section links to official gov source

## Business Logic

### Support Score
```
upvote_ratio = upvotes / (upvotes + downvotes)

Verdict:
  - ratio >= 0.80 → "Likely Support"
  - ratio <= 0.20 → "Likely Oppose"
  - else → "Mixed/Unsure"
  - no votes → "Not enough votes"
```

### User Recap
- **Liked**: Sections user upvoted (with summaries)
- **Disliked**: Sections user downvoted (with summaries)
- **Verdict**: Overall support likelihood
- **Disclaimer**: "This is informational, not advice"

## Tech Stack

- **Backend**: Python 3.11+, FastAPI, SQLAlchemy, Alembic
- **Database**: PostgreSQL
- **Cache/Queue**: Redis
- **Worker**: Celery + Redis broker
- **LLM**: Pluggable (OpenAI/Anthropic/local via abstraction)
- **Orchestration**: n8n (self-hosted)
- **Frontend**: Next.js, React, Tailwind CSS
- **Deployment**: Docker Compose

## Database Schema

### Tables
- **bills**: Core bill metadata (congress, type, number, status, etc.)
- **bill_versions**: Different text versions (enrolled, engrossed, etc.)
- **bill_sections**: Individual sections with text, summaries, and evidence
- **users**: User accounts (initially anonymous sessions)
- **votes**: User votes per section (up/down/skip)
- **user_bill_summaries**: Cached support scores and recaps per user

## Local Development Setup

### Prerequisites
- Docker and Docker Compose
- Congress.gov API key from api.data.gov
- LLM API key (OpenAI or Anthropic)

### Steps

1. **Clone and navigate**:
   ```bash
   cd justabill
   ```

2. **Copy environment template**:
   ```bash
   cp .env.example .env
   ```

3. **Edit `.env`** with your API keys:
   ```
   CONGRESS_API_KEY=your_key_here
   LLM_PROVIDER=openai
   LLM_MODEL=gpt-4
   LLM_API_KEY=your_key_here
   ```

4. **Start services**:
   ```bash
   docker-compose up -d
   ```

5. **Run migrations**:
   ```bash
   docker-compose exec backend alembic upgrade head
   ```

6. **Seed demo bills** (optional):
   ```bash
   docker-compose exec backend python scripts/seed_demo.py
   ```

7. **Access services**:
   - Frontend: http://localhost:3000
   - Backend API: http://localhost:8000
   - n8n: http://localhost:5678
   - API Docs: http://localhost:8000/docs

## API Endpoints

### Core
- `GET /health` - Health check
- `GET /bills` - List bills (pagination, filters)
- `GET /bills/{bill_id}` - Bill detail with sections
- `POST /ingest/bill` - Ingest new bill (called by n8n)
- `POST /bills/{bill_id}/resummarize` - Trigger re-summarization

### Voting
- `POST /bills/{bill_id}/vote` - Submit vote for a section
- `GET /bills/{bill_id}/user-summary` - Get user's support score and recap

## n8n Workflows

### Setup
1. Access n8n at http://localhost:5678
2. Import workflows from `/n8n/*.json`
3. Configure credentials (Congress API key, backend URL)
4. Activate workflows

### Workflows
- **Daily Bill Sync** (`daily-bill-sync.json`): Runs daily at 6 AM ET
- **Re-summarize Bill** (`resummarize-bill.json`): Manual/webhook trigger
- **Dead Letter Queue** (`alert-workflow.json`): Error notifications

## Testing

```bash
# Run all tests
docker-compose exec backend pytest

# Run with coverage
docker-compose exec backend pytest --cov=app --cov-report=html

# Run specific test
docker-compose exec backend pytest tests/test_sectioning.py
```

## Demo Script

### 1. Ingest a Bill (Manual)
```bash
curl -X POST http://localhost:8000/ingest/bill \
  -H "Content-Type: application/json" \
  -d '{
    "congress": 118,
    "billType": "hr",
    "billNumber": 1234
  }'
```

### 2. View Bills
Visit http://localhost:3000 - you should see the ingested bill

### 3. Vote on Sections
Click a bill → Vote on each section → Submit votes

### 4. View Your Recap
Click "View My Summary" to see your support score and liked/disliked sections

### 5. Check Evidence
Expand "Evidence" on any section card to see grounding quotes

## Security & Privacy

- API keys stored only in environment variables
- Passwords hashed with bcrypt (when auth is added)
- Anonymous sessions supported (no PII required)
- All bill text is public domain (U.S. government sources)

## License

MIT

## Disclaimer

This app is informational. It summarizes bill text and reflects your votes; it does not provide legal, financial, or political advice.
